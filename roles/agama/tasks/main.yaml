- name: Create dir
  file:
    path: /opt/agama
    state: directory

- name: Download agama and Dockerfile
  get_url:
    url: "{{ item }}"
    dest: /opt/agama/
  loop:
    - https://raw.githubusercontent.com/hudolejev/agama/master/agama.py
    - https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile

- name: Build image
  community.docker.docker_image:
    name: agama
    source: build
    build:
      path: /opt/agama

- name: agama containers
  community.docker.docker_container:
    name: "agama-{{ item }}"
    image: agama
    env:
      AGAMA_DATABASE_URI: "mysql+pymysql://{{ mysql_user }}:{{ mysql_password }}@{{ mysql_host }}/{{ agama_db }}"
    published_ports: "{{ item }}:8000"
  no_log: true
  loop: "{{ agama_containers_ports }}"
